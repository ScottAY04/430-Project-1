<!DOCTYPE html>
<html lang="eng">
<head>
    <title>Country API Project</title>
    <link rel="stylesheet" type="text/css" href = "/style.css">

    <script>
        const handleResponse = async (response, method) => {
            const content = document.querySelector('#content');

            switch(response.status) {
                case 200: 
                content.innerHTML = `<b>Success</b>`;
                break;
                case 201:
                content.innerHTML = `<b>Created</b>`;
                break;
                case 204:
                content.innerHTML = `<b>Updated(No Content)</b>`;
                break;
                case 400: 
                content.innerHTML = `<b>Bad Request</b>`;
                break;
                case 404:
                content.innerHTML = `<b>Not Found</b>`;
                break;
                default: 
                content.innerHTML = `Error code not implemented by client.`;
                break;
            }

            console.log(method);
            if(method && response.status !== 204){
                const obj = await response.json();
                if(obj.message){
                    content.innerHTML += `<p>${obj.message}</p>`;
                    console.log(obj);
                };
            }else{
                //puts out nothing for now
            }
        }

        //request update with no input
        const requestUpdateNoI = async (getHead ,sectionGiven) => {
            let method;
            //for the get or head method
            {
                //for the get or head response
                const methodSelector = getHead.querySelector('#getButton');
                if(methodSelector.checked){
                    method = methodSelector.getAttribute('value');
                }else{
                    method = 'head';
                }
            }

            //for the actual request stuff
            const section = sectionGiven.getAttribute('action');

            let response = await fetch (section, {
                method,
                headers:{
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
            });

            handleResponse(response, method === 'GET');
        }

        //normal request update with an input
        const requestUpdate = async (getHead, sectionGiven) =>{
            let method;
            //for the get or head method
            {
                //for the get or head response
                const methodSelector = getHead.querySelector('#getButton');
                if(methodSelector.checked){
                    method = methodSelector.getAttribute('value');
                }else{
                    method = 'HEAD';
                }
            }

             //for the actual request stuff
            let section = `${sectionGiven.getAttribute('action')}`;
            ///byContinent?region=Asia
            let queryString = `?`;

            const amntInputs = sectionGiven.querySelectorAll('.inputResponse');
            console.log(amntInputs);
            for(let i = 0; i < amntInputs.length; i++){
                if(amntInputs[i].value && i === 0){
                    queryString += `${amntInputs[i].getAttribute('name')}=${amntInputs[i].value}`
                }
                if(amntInputs[i].value && i !== 0)
                {
                    queryString += `&${amntInputs[i].getAttribute('name')}=${amntInputs[i].value}`
                }
            }

            section += queryString;
            console.log(section);

            let response = await fetch (section, {
                method,
                headers:{
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
            });

            handleResponse(response, method === 'GET');
        }

        const sendPost = async (sectionGiven)=> {
            const url = sectionGiven.getAttribute('action');
            const method = sectionGiven.getAttribute('method');

            const name = sectionGiven.querySelector('#country').value;
            const newData = sectionGiven.querySelector('#answer').value;

            let formData = JSON.stringify({name, newData});

            let response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': formData.length,
                    'Accept': 'application/json',
                },
                body: formData,
            });

            handleResponse(response, method === 'post')
        }

        const init = () => {
            const methodType = document.querySelector('#methodType');

            //all get/head requests
            const getAll = document.querySelector('#allCountry');
            const getSingle = document.querySelector('#getCountry');
            const byContinent = document.querySelector('#byContinent');
            const byLetter = document.querySelector('#byLetter');
            const getCurrency = document.querySelector('#currency');
            const addFamousLocation = document.querySelector('#famousLocation');
            const rateCountry = document.querySelector('#rateCountry');

            const getAllCountries =(e) => {
                e.preventDefault();
                requestUpdateNoI(methodType, getAll);
                return false;
            }

            const getCountry = (e) => {
                e.preventDefault();
                requestUpdate(methodType, getSingle);
                return false;
            }

            const getByContinent = (e)=>{
                e.preventDefault();
                requestUpdate(methodType, byContinent);
                return false;
            }

            const getByLetter = (e) => {
                e.preventDefault();
                requestUpdate(methodType, byLetter);
                return false;
            }

            const getCountryCurrency = (e)=> {
                e.preventDefault();
                requestUpdate(methodType, getCurrency);
                return false;
            }

            const addFamous = (e) => {
                e.preventDefault();
                sendPost(addFamousLocation);
                return false;
            }

            const addRating = (e) => {
                e.preventDefault();
                sendPost(rateCountry);
                return false;
            }


            getAll.addEventListener('submit', getAllCountries);
            getSingle.addEventListener('submit', getCountry);
            byContinent.addEventListener('submit', getByContinent);
            byLetter.addEventListener('submit', getByLetter);
            getCurrency.addEventListener('submit', getCountryCurrency);
            addFamousLocation.addEventListener('submit', addFamous);
            rateCountry.addEventListener('submit', addRating);
        }

        window.onload = init;
    </script>
</head>

<body>
    <h1>Countries API App</h1>
    <section id="container">
        <section id="getHeadArea">
            <!-- Get or head selector --->
            <h2>
                <section id="methodType">
                    <label>
                    <input id="getButton" type="radio" name="method" value="GET" checked>GET
                </label>
                <label>
                    <input type="radio" name="method" value="HEAD">HEAD
                </label>
                </section>
            </h2>

                <form id="allCountry" action = '/allCountry'>
                    <h2>/allCountries</h2>
                    <button type="submit">Send Request</button>
                </form>

                <form id="getCountry" action = '/getCountry'>
                    <h2>/getCountry</h2>
                    <label>Country: </label>
                    <input class="inputResponse" type="text" name="name">
                    <br>
                    <button type="submit">Send Request</button>
                </form>

                <form id="byContinent" action = '/getCountryByContinent'>
                    <h2>/getCountryByContinent</h2>
                    <label>Continent: </label>
                    <input class="inputResponse" type="text" name="region">
                    <br>
                    <button type="submit">Send Request</button>
                </form>

                <form id="byLetter" action="/getCountryByLetter">
                    <h2>/getCountryByLetter</h2>
                    <label >First Letter: </label>
                    <input class="inputResponse" type="text" name="first" maxlength="1">
                    <br>
                    <label>Last Letter: </label>
                    <input class="inputResponse" type="text" name="last" maxlength="1">
                    <br>
                    <button type="submit">Send Request</button>
                </form>

                <form id="currency" action="/getCurrency">
                    <h2>/getCurrency</h2>
                    <label >Country: </label>
                    <input class="inputResponse" type="text" name="country">
                    <br>
                    <button type="submit">Send Request</button>
                </form>
        </section>

        <section id="postArea">
            <h2>Post Area</h2>
            <form id="famousLocation" action="/addFamousLocation" method="post">
                <h2>/addFamousLocation</h2>
                <label>Country: </label>
                <input id="country" type="text">
                <br>
                <label>Location: </label>
                <input id="answer" type="text">
                <br>
                <button type="submit">Send Request</button>
            </form>
            <form id="rateCountry" action="/rateCountry" method="post">
                <h2>/rateCountry</h2>
                <label>Country: </label>
                <input id="country" type="text">
                <br>
                <label>Rating(1-5): </label>
                <input id="answer" type="number" min="1" max="5">
                <br>
                <button type="submit">Send Request</button>
            </form>
        </section>
    </section>
    <section id="content">
    </section>
</body>
</html>